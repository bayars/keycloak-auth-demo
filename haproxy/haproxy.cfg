global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048
    lua-load /etc/haproxy/jwt_validate.lua

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Frontend for HTTPS traffic
frontend https_frontend
    bind *:443 ssl crt /etc/haproxy/certs/server.pem
    mode http
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Host ACL
    acl acl_lab-test2 hdr(host) -i lab-test2.safa.nisvcg.comp.net localhost 10.0.0.172
    
    # Path ACLs
    acl path_auth_keycloak path_beg /auth
    acl path_admin_console path_beg /auth/admin/master/console
    acl path_api path_beg /api
    acl path_health path /health
    acl path_static path_beg /static
    acl path_assets path_beg /assets
    acl path_login path /login
    acl path_logout path /logout
    acl path_callback path_beg /callback
    acl path_webauth path /webauth
    
    # JWT Token extraction
    http-request set-var(txn.auth_header) req.hdr(Authorization)
    acl has_auth_header var(txn.auth_header) -m found
    
    # Debug logging
    http-request capture req.hdr(Authorization) len 200
    
    # JWT validation using Lua script
    acl has_token var(txn.auth_header) -m found
    acl valid_jwt_format var(txn.auth_header) -m reg ^Bearer\s+[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$
    
    # Admin role check using Lua script
    http-request set-var(txn.is_admin) lua.validate_admin_jwt if has_token valid_jwt_format
    acl is_admin_user var(txn.is_admin) str "true"
    
    # Routing rules for lab-test2
    # 1. Health check (no auth)
    use_backend be-lab-test2-api if acl_lab-test2 path_health
    
    # 2. WebAuth page (serve authentication interface)
    use_backend be-lab-test2-frontend if acl_lab-test2 path_webauth
    
    # 3. Login/logout/callback paths (redirect to Keycloak)
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_login
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_logout
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_callback
    
    # 4. Keycloak admin console (admin role required)
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_admin_console is_admin_user
    http-request return status 403 content-type "application/json" string '{"error":"Access denied. Admin role required."}' if acl_lab-test2 path_admin_console !is_admin_user
    
    # 5. Other Keycloak paths (admin role required)
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_auth_keycloak is_admin_user
    http-request return status 403 content-type "application/json" string '{"error":"Access denied. Admin role required."}' if acl_lab-test2 path_auth_keycloak !is_admin_user
    
    # 6. API routes (JWT required)
    use_backend be-lab-test2-api if acl_lab-test2 path_api
    
    # 7. Static assets (CSS, JS, images)
    use_backend be-lab-test2-frontend if acl_lab-test2 path_static
    use_backend be-lab-test2-frontend if acl_lab-test2 path_assets
    
    # Set dynamic variables for redirect
    http-request set-var(txn.host) req.hdr(host)
    http-request set-var(txn.redirect_uri) str("%[var(txn.host)]/callback")
    http-request set-var(txn.auth_url) str("%[var(txn.host)]/auth/realms/myrealm/protocol/openid-connect/auth")
    
    # 8. Default: redirect to webauth page for authentication (only if not authenticated)
    http-request redirect code 302 location "%[var(txn.host)]/webauth" if acl_lab-test2 !has_token
    
    # 9. Default: serve frontend if authenticated
    use_backend be-lab-test2-frontend if acl_lab-test2 has_token
    

# Backend for Keycloak
backend be-lab-test2-keycloak
    mode http
    balance roundrobin
    option httpchk GET /auth/realms/myrealm
    http-check expect status 200
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Host %[req.hdr(host)]
    http-request set-header Host %[req.hdr(host)]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Server %[req.hdr(host)]
    # Override CSP header for admin console to allow HTTPS frames
    http-response set-header Content-Security-Policy "frame-src 'self' https:; frame-ancestors 'self'; object-src 'none';"
    server keycloak keycloak:8080 check

# Backend for API
backend be-lab-test2-api
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    # Forward the JWT token
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Authorization %[var(txn.auth_header)] if { var(txn.auth_header) -m found }
    server api1 api:8000 check

# Backend for Frontend
backend be-lab-test2-frontend
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    server frontend1 frontend:3000 check

# Stats interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
