global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Frontend for HTTPS traffic
frontend https_frontend
    bind *:443 ssl crt /etc/haproxy/certs/server.pem
    mode http
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Host ACL
    acl acl_lab-test2 hdr(host) -i lab-test2.safa.nisvcg.comp.net localhost 10.0.0.172
    
    # Path ACLs
    acl path_auth_keycloak path_beg /auth
    acl path_admin_console path_beg /auth/admin/master/console
    acl path_api path_beg /api
    acl path_login path /api/login
    acl path_change_password path /api/change-password
    acl path_health path /health
    acl path_static path_beg /static
    acl path_assets path_beg /assets
    
    # JWT Token extraction (simplified)
    http-request set-var(txn.auth_header) req.hdr(Authorization)
    acl has_auth_header var(txn.auth_header) -m found
    
    # Debug logging
    http-request capture req.hdr(Authorization) len 200
    
    # JWT validation (simplified)
    acl has_token var(txn.auth_header) -m found
    acl valid_jwt_format var(txn.auth_header) -m reg ^Bearer\s+[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$
    
    # Admin role check using API validation
    # Forward Authorization header to API for validation
    acl has_auth_header var(txn.auth_header) -m found
    acl is_admin_user var(txn.auth_header) -m found
    
    # Routing rules for lab-test2
    # 1. Health check (no auth)
    use_backend be-lab-test2-api if acl_lab-test2 path_health
    
    # 2. Login and password change (no auth required)
    use_backend be-lab-test2-api if acl_lab-test2 path_login
    use_backend be-lab-test2-api if acl_lab-test2 path_change_password
    
    # 3. Keycloak admin console (direct access - Keycloak handles its own auth)
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_admin_console
    
    # 4. Other Keycloak paths (direct access - Keycloak handles its own auth)
    use_backend be-lab-test2-keycloak if acl_lab-test2 path_auth_keycloak
    
    # 5. API routes (JWT required, except login and change-password)
    use_backend be-lab-test2-api if acl_lab-test2 path_api
    
    # 6. Static assets (CSS, JS, images)
    use_backend be-lab-test2-frontend if acl_lab-test2 path_static
    use_backend be-lab-test2-frontend if acl_lab-test2 path_assets
    
    # 7. Default: frontend application
    use_backend be-lab-test2-frontend if acl_lab-test2
    

# Backend for Keycloak
backend be-lab-test2-keycloak
    mode http
    balance roundrobin
    # option httpchk GET /auth
    # http-check expect status 200
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Host %[req.hdr(host)]
    http-request set-header Host %[req.hdr(host)]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Server %[req.hdr(host)]
    # Override CSP header for admin console to allow HTTPS frames
    http-response set-header Content-Security-Policy "frame-src 'self' https:; frame-ancestors 'self'; object-src 'none';"
    server keycloak keycloak:8080 check

# Backend for API
backend be-lab-test2-api
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    # Forward the JWT token
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Authorization %[var(txn.auth_header)] if { var(txn.auth_header) -m found }
    server api1 api:8000 check

# Backend for Frontend
backend be-lab-test2-frontend
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    server frontend1 frontend:3000 check

# Stats interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
